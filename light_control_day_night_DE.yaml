blueprint:
  name: Lichtsteuerung mit Tag- und Nachtmodus
  description: |
    v1.1.0 - Professionelle KNX-Lichtsteuerung mit szenenbasiertem Ausschalten
    
    Steuert Licht mit drei Tastern: Tagbeleuchtung, Nachtbeleuchtung und automatische Auswahl.
    Toggle-Funktion: Ist die Szene bereits aktiv, werden alle Szenen-Lichter ausgeschaltet.
    
    NEU in v1.1.0: Szenenbasiertes Ausschalten
    ‚Ä¢ Toggle schaltet nur Lichter aus die in der aktiven Szene enthalten sind
    ‚Ä¢ L√∂st geteilte-Lampen-Problem (Lampe beleuchtet mehrere R√§ume)
    ‚Ä¢ Pr√§ziser und flexibler
    
    ‚ö†Ô∏è WICHTIG: Szenen m√ºssen ALLE relevanten Lichter enthalten!
    
    Optional: Vierter Taster zum direkten Ausschalten (egal welcher Status).
    Optional: Durchgangslicht bei Pr√§senz.
    
    ‚öôÔ∏è KNX-Pr√§senzmelder Steuerung:
    Der KNX-Sensor steuert selbst:
    ‚Ä¢ Nachlaufzeit (wie lange Licht an bleibt)
    ‚Ä¢ Helligkeitsschwelle (nur bei Dunkelheit triggern)
    ‚Ä¢ Bewegungserkennung
    
    Blueprint reagiert nur auf Pr√§senzmelder on/off:
    ‚Ä¢ Pr√§senzmelder "on" ‚Üí Durchgangslicht EIN
    ‚Ä¢ Pr√§senzmelder "off" ‚Üí Durchgangslicht AUS
    
    WICHTIG - Optionale Felder:
    Wenn du bestimmte Features NICHT nutzen m√∂chtest (z.B. kein Durchgangslicht),
    lasse bei den entsprechenden Feldern einfach "Sonne" (sun.sun) oder "31/7/255" ausgew√§hlt.
    Das Blueprint erkennt dies als "nicht konfiguriert" und √ºberspringt das Feature.
  domain: automation
  input:
    # ========================================================================
    # KNX Taster Gruppenadressen
    # Format: Hauptgruppe/Mittelgruppe/Untergruppe (z.B. "1/2/3")
    # ========================================================================
    
    taster_tag_ga:
      name: üîÜ Taster Tagbeleuchtung
      description: |
        KNX Gruppenadresse im Format: Hauptgruppe/Mittelgruppe/Untergruppe
        Beispiel: 1/2/1
      selector:
        text:
    
    taster_nacht_ga:
      name: üåô Taster Nachtbeleuchtung
      description: |
        KNX Gruppenadresse im Format: Hauptgruppe/Mittelgruppe/Untergruppe
        Beispiel: 1/2/2
      selector:
        text:
    
    taster_auto_ga:
      name: üîÑ Taster Automatik
      description: |
        KNX Gruppenadresse im Format: Hauptgruppe/Mittelgruppe/Untergruppe
        Beispiel: 1/2/3
      selector:
        text:
    
    taster_aus_ga:
      name: ‚èª Taster Alles Aus (optional)
      description: |
        KNX Gruppenadresse f√ºr "Alles Aus" - schaltet das Licht immer aus.
        Format: Hauptgruppe/Mittelgruppe/Untergruppe
        Beispiel: 1/2/10
        
        Wenn nicht ben√∂tigt: "31/7/255" stehen lassen (wird ignoriert).
      default: "31/7/255"
      selector:
        text:
    
    status_rueckmeldung_ga:
      name: üì° Status-R√ºckmeldung (optional)
      description: |
        KNX Gruppenadresse f√ºr Statusr√ºckmeldung an KNX-Bus.
        Format: Hauptgruppe/Mittelgruppe/Untergruppe
        Beispiel: 1/2/20
        
        Funktionsweise:
        ‚Ä¢ Licht EIN (Tag/Nacht/Durchgang) ‚Üí Sendet "1" (Ein)
        ‚Ä¢ Licht AUS ‚Üí Sendet "0" (Aus)
        
        N√ºtzlich f√ºr:
        ‚Ä¢ Status-LEDs an KNX-Tastern
        ‚Ä¢ KNX-Visualisierung
        ‚Ä¢ Integration mit anderen KNX-Ger√§ten
        
        Wenn nicht ben√∂tigt: "31/7/255" stehen lassen (wird ignoriert).
      default: "31/7/255"
      selector:
        text:
    
    # ========================================================================
    # Szenen und Sensoren
    # ========================================================================
    
    tag_nacht_sensor:
      name: üåì Tag/Nacht Sensor
      description: |
        Bin√§rer Sensor zur Unterscheidung zwischen Tag und Nacht.
        "on" = Nacht | "off" = Tag
      selector:
        entity:
          domain: binary_sensor
    
    szene_tag:
      name: ‚òÄÔ∏è Szene Tagbeleuchtung
      description: Szene die bei Tagbetrieb aktiviert werden soll
      selector:
        entity:
          domain: scene
    
    szene_nacht:
      name: üåõ Szene Nachtbeleuchtung
      description: Szene die bei Nachtbetrieb aktiviert werden soll
      selector:
        entity:
          domain: scene
    
    licht_gruppe:
      name: üí° Lichtgruppe
      description: |
        Lichtgruppe mit allen Lampen des Raums.
        
        Verwendung:
        ‚Ä¢ "Alles Aus" Taster (schaltet wirklich alle Lichter aus)
        ‚Ä¢ Optionale Verwendung in anderen Automationen
        
        ‚ö†Ô∏è WICHTIG ab v1.1.0:
        Toggle-Funktionen nutzen Szenen-Lichter, nicht die Lichtgruppe!
        Die Lichtgruppe wird nur noch f√ºr den "Alles Aus" Taster ben√∂tigt.
      selector:
        entity:
          domain: light
    
    status_helper:
      name: üìä Status Helper
      description: |
        Input Select Helper f√ºr die Statusverwaltung.
        Optionen: aus, tag, nacht, durchgang
        
        Erstelle unter Einstellungen ‚Üí Ger√§te & Dienste ‚Üí Helfer ‚Üí Input Select mit diesen Optionen:
        - aus
        - tag
        - nacht
        - durchgang (nur n√∂tig wenn Pr√§senzmelder verwendet wird)
      selector:
        entity:
          domain: input_select
    
    # ========================================================================
    # Optional: Pr√§senzmelder & Durchgangslicht
    # WICHTIG: Wenn kein Durchgangslicht gew√ºnscht, w√§hle denselben Sensor wie "Tag/Nacht Sensor"
    # ========================================================================
    
    praesenzmmelder:
      name: üö∂ Pr√§senzmelder f√ºr Durchgangslicht
      description: |
        Bin√§rer Sensor f√ºr automatisches Durchgangslicht bei Bewegung.
        
        ‚öôÔ∏è WICHTIG - Konfiguration im KNX-Pr√§senzmelder (ETS):
        Der KNX-Sensor steuert selbst:
        ‚Ä¢ Nachlaufzeit (empfohlen: 30-120 Sekunden)
        ‚Ä¢ Helligkeitsschwelle (z.B. nur bei < 20 Lux triggern)
        ‚Ä¢ Bewegungserkennung
        
        Das Blueprint reagiert nur auf das "on"/"off" Signal des Sensors.
        
        Funktionsweise:
        ‚Ä¢ Pr√§senzmelder "on" ‚Üí Durchgangslicht EIN
        ‚Ä¢ Pr√§senzmelder "off" ‚Üí Durchgangslicht AUS
        
        ‚ö†Ô∏è WENN DU KEIN DURCHGANGSLICHT M√ñCHTEST:
        W√§hle hier EXAKT DENSELBEN SENSOR wie bei "Tag/Nacht Sensor" (weiter oben).
        Das Blueprint erkennt dies automatisch und deaktiviert das Durchgangslicht.
        
        Beispiel:
        - Tag/Nacht Sensor: binary_sensor.tag_nacht
        - Pr√§senzmelder: binary_sensor.tag_nacht ‚Üê Gleich = Durchgangslicht deaktiviert
      selector:
        entity:
          filter:
            - domain: binary_sensor
          multiple: false
    
    szene_durchgang:
      name: üåü Durchgangsszene Tag (optional)
      description: |
        Szene f√ºr automatisches Durchgangslicht tags√ºber (meist gedimmt).
        
        ‚ö†Ô∏è Wenn du KEIN Durchgangslicht m√∂chtest: Lasse "Sonne" (sun.sun) ausgew√§hlt!
      default: sun.sun
      selector:
        entity:
          domain: scene
    
    szene_durchgang_nacht:
      name: üåô Durchgangsszene Nacht (optional)
      description: |
        Separate Szene f√ºr automatisches Durchgangslicht nachts (meist noch dunkler).
        
        Funktionsweise:
        ‚Ä¢ Wenn konfiguriert: Diese Szene wird nachts verwendet
        ‚Ä¢ Wenn NICHT konfiguriert (sun.sun): Normale Durchgangsszene wird auch nachts verwendet
        
        Typisch:
        ‚Ä¢ Tag-Durchgang: 10-20% Helligkeit
        ‚Ä¢ Nacht-Durchgang: 5-10% Helligkeit, warmwei√ü
        
        ‚ö†Ô∏è Wenn du die gleiche Szene Tag+Nacht willst: Lasse "Sonne" (sun.sun) ausgew√§hlt!
      default: sun.sun
      selector:
        entity:
          domain: scene
    
    durchgang_override:
      name: üö´ Durchgangslicht Override (optional)
      description: |
        Schalter oder Media Player zum Deaktivieren des Durchgangslichts.
        
        Funktionsweise:
        ‚Ä¢ Input Boolean/Switch: Status "on" ‚Üí Kein Durchgangslicht
        ‚Ä¢ Media Player: Status "on", "playing" oder "paused" ‚Üí Kein Durchgangslicht
        
        Beispiele:
        ‚Ä¢ input_boolean.gaestemodus (blockiert wenn "on")
        ‚Ä¢ switch.durchgang_deaktivieren (blockiert wenn "on")
        ‚Ä¢ media_player.wohnzimmer_tv (blockiert wenn an/spielt)
        
        ‚ö†Ô∏è Wenn du keinen Override brauchst: Lasse "Sonne" (sun.sun) ausgew√§hlt!
      default: sun.sun
      selector:
        entity:
          filter:
            - domain: input_boolean
            - domain: switch
            - domain: media_player
          multiple: false
    
    # ========================================================================
    # Optional: Langzeit-Abwesenheitserkennung (20min / 60min)
    # ========================================================================
    
    praesenz_langzeit_1:
      name: ‚è≤Ô∏è Pr√§senzmelder Langzeit 1 (optional)
      description: |
        Pr√§senzmelder-Entit√§t die nach mittellanger Abwesenheit abschaltet.
        
        ‚ö†Ô∏è WICHTIG: Muss ein ANDERER Sensor als der Durchgangs-Pr√§senzmelder sein!
        Verwende separate Ausg√§nge des KNX-Sensors mit unterschiedlichen Nachlaufzeiten.
        
        Funktionsweise:
        ‚Ä¢ Bei Bewegung: Schaltet auf "on"
        ‚Ä¢ Nach X Minuten keine Bewegung: Schaltet auf "off"
        ‚Ä¢ "off"-Signal ‚Üí Blueprint schaltet ausgew√§hlte Entit√§ten aus
        ‚Ä¢ Schaltet NUR aus wenn Status "aus" oder "durchgang" ist
        ‚Ä¢ Schaltet NICHT aus bei aktiven Tag/Nacht-Szenen (sch√ºtzt vor versehentlichem Ausschalten)
        
        Konfiguration der Nachlaufzeit in ETS:
        ‚Ä¢ Empfohlen: 15-30 Minuten
        ‚Ä¢ OHNE Helligkeitsabh√§ngigkeit (immer aktiv)
        
        ‚ö†Ô∏è Wenn nicht ben√∂tigt: W√§hle denselben Sensor wie "Tag/Nacht Sensor".
      selector:
        entity:
          filter:
            - domain: binary_sensor
          multiple: false
    
    praesenz_langzeit_1_lichter:
      name: üí° Langzeit 1 - Auszuschaltende Entit√§ten (optional)
      description: |
        Entit√§ten die nach mittellanger Abwesenheit ausgeschaltet werden sollen.
        
        Funktioniert mit:
        ‚Ä¢ Lichtern (light.*)
        ‚Ä¢ Switches (switch.*)
        ‚Ä¢ Anderen ausschaltbaren Entit√§ten
        
        Typischer Anwendungsfall:
        Nach mittellanger Abwesenheit ‚Üí Einzelne Lampen/Ger√§te aus
        (Hauptbeleuchtung bleibt noch an)
        
        Beispiele:
        ‚Ä¢ light.wohnzimmer_stehlampe
        ‚Ä¢ switch.steckdose_leselampe
        ‚Ä¢ light.wohnzimmer_led_strip
        
        ‚ö†Ô∏è Wenn nicht ben√∂tigt: Leer lassen.
      default: {}
      selector:
        target:
          entity:
            domain:
              - light
              - switch
    
    praesenz_langzeit_2:
      name: ‚è≥ Pr√§senzmelder Langzeit 2 (optional)
      description: |
        Pr√§senzmelder-Entit√§t die nach sehr langer Abwesenheit abschaltet.
        
        ‚ö†Ô∏è WICHTIG: Muss ein ANDERER Sensor als der Durchgangs-Pr√§senzmelder sein!
        Verwende separate Ausg√§nge des KNX-Sensors mit unterschiedlichen Nachlaufzeiten.
        
        Funktionsweise:
        ‚Ä¢ Bei Bewegung: Schaltet auf "on"
        ‚Ä¢ Nach X Minuten keine Bewegung: Schaltet auf "off"
        ‚Ä¢ "off"-Signal ‚Üí Blueprint schaltet ALLE Lichter aus (au√üer ausgeschlossene)
        ‚Ä¢ Schaltet NUR aus wenn Status "aus" oder "durchgang" ist
        ‚Ä¢ Schaltet NICHT aus bei aktiven Tag/Nacht-Szenen (sch√ºtzt vor versehentlichem Ausschalten)
        
        Konfiguration der Nachlaufzeit in ETS:
        ‚Ä¢ Empfohlen: 45-90 Minuten
        ‚Ä¢ OHNE Helligkeitsabh√§ngigkeit (immer aktiv)
        
        Anwendungsfall:
        Sicherheit - nach sehr langer Zeit ist garantiert niemand mehr da.
        
        ‚ö†Ô∏è Wenn nicht ben√∂tigt: W√§hle denselben Sensor wie "Tag/Nacht Sensor".
      selector:
        entity:
          filter:
            - domain: binary_sensor
          multiple: false
    
    praesenz_langzeit_2_exclude_labels:
      name: üè∑Ô∏è Langzeit 2 - Ausgeschlossene Labels (optional)
      description: |
        Labels von Lichtern die bei Langzeit 2 NICHT ausgeschaltet werden sollen.
        
        So funktioniert's:
        1. Vergib Labels an Lichter in Home Assistant
        2. W√§hle hier die Labels aus dem Dropdown aus
        3. Lichter mit diesen Labels bleiben bei Langzeit 2 an
        
        Anwendungsf√§lle:
        ‚Ä¢ Sicherheitsbeleuchtung (Label: "sicherheit")
        ‚Ä¢ Au√üenbeleuchtung (Label: "au√üen")
        ‚Ä¢ Wichtige Grundbeleuchtung (Label: "wichtig")
        
        Funktionsweise:
        Alle Lichter der Lichtgruppe werden ausgeschaltet,
        AUSSER diejenigen mit den hier ausgew√§hlten Labels.
        
        ‚ö†Ô∏è Wenn alle Lichter ausgeschaltet werden sollen: Keine Labels ausw√§hlen.
      default: []
      selector:
        label:
          multiple: true

mode: restart
max_exceeded: silent

trigger:
  - platform: event
    event_type: knx_event
    event_data:
      destination: !input taster_tag_ga
    id: tag
  
  - platform: event
    event_type: knx_event
    event_data:
      destination: !input taster_nacht_ga
    id: nacht
  
  - platform: event
    event_type: knx_event
    event_data:
      destination: !input taster_auto_ga
    id: auto
  
  - platform: event
    event_type: knx_event
    event_data:
      destination: !input taster_aus_ga
    id: alles_aus
  
  - platform: state
    entity_id: !input praesenzmmelder
    to: "on"
    id: praesenz_on
  
  - platform: state
    entity_id: !input praesenzmmelder
    to: "off"
    id: praesenz_off
  
  - platform: state
    entity_id: !input praesenz_langzeit_1
    to: "off"
    id: langzeit_1_off
  
  - platform: state
    entity_id: !input praesenz_langzeit_2
    to: "off"
    id: langzeit_2_off

variables:
  praesenzmmelder: !input praesenzmmelder
  tag_nacht_sensor: !input tag_nacht_sensor
  durchgang_override: !input durchgang_override
  szene_durchgang: !input szene_durchgang
  szene_durchgang_nacht: !input szene_durchgang_nacht
  szene_tag: !input szene_tag
  szene_nacht: !input szene_nacht
  status_helper: !input status_helper
  taster_aus_ga: !input taster_aus_ga
  status_rueckmeldung_ga: !input status_rueckmeldung_ga
  praesenz_langzeit_1: !input praesenz_langzeit_1
  praesenz_langzeit_1_lichter: !input praesenz_langzeit_1_lichter
  praesenz_langzeit_2: !input praesenz_langzeit_2
  praesenz_langzeit_2_exclude_labels: !input praesenz_langzeit_2_exclude_labels

action:
  - choose:
      # Taster Tagbeleuchtung
      - conditions:
          - condition: trigger
            id: tag
        sequence:
          - if:
              # Tagszene ist bereits aktiv
              - condition: state
                entity_id: !input status_helper
                state: "tag"
            then:
              # Szenenbasiertes Ausschalten - nur Lichter der Tagszene
              - variables:
                  lights_to_turn_off: "{{ state_attr(szene_tag, 'entity_id') or [] }}"
              - if:
                  - condition: template
                    value_template: "{{ lights_to_turn_off | length > 0 }}"
                then:
                  - service: homeassistant.turn_off
                    target:
                      entity_id: "{{ lights_to_turn_off }}"
              - service: input_select.select_option
                target:
                  entity_id: !input status_helper
                data:
                  option: "aus"
              # KNX Status-R√ºckmeldung senden
              - if:
                  - condition: template
                    value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                then:
                  - service: knx.send
                    data:
                      address: "{{ status_rueckmeldung_ga }}"
                      payload: 0
            else:
              # Tagszene aktivieren (direkter Wechsel m√∂glich, beendet auch Durchgangsmodus)
              - service: scene.turn_on
                target:
                  entity_id: !input szene_tag
              - service: input_select.select_option
                target:
                  entity_id: !input status_helper
                data:
                  option: "tag"
              # KNX Status-R√ºckmeldung senden
              - if:
                  - condition: template
                    value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                then:
                  - service: knx.send
                    data:
                      address: "{{ status_rueckmeldung_ga }}"
                      payload: 1
      
      # Taster Nachtbeleuchtung
      - conditions:
          - condition: trigger
            id: nacht
        sequence:
          - if:
              # Nachtszene ist bereits aktiv
              - condition: state
                entity_id: !input status_helper
                state: "nacht"
            then:
              # Szenenbasiertes Ausschalten - nur Lichter der Nachtszene
              - variables:
                  lights_to_turn_off: "{{ state_attr(szene_nacht, 'entity_id') or [] }}"
              - if:
                  - condition: template
                    value_template: "{{ lights_to_turn_off | length > 0 }}"
                then:
                  - service: homeassistant.turn_off
                    target:
                      entity_id: "{{ lights_to_turn_off }}"
              - service: input_select.select_option
                target:
                  entity_id: !input status_helper
                data:
                  option: "aus"
              # KNX Status-R√ºckmeldung senden
              - if:
                  - condition: template
                    value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                then:
                  - service: knx.send
                    data:
                      address: "{{ status_rueckmeldung_ga }}"
                      payload: 0
            else:
              # Nachtszene aktivieren (direkter Wechsel m√∂glich, beendet auch Durchgangsmodus)
              - service: scene.turn_on
                target:
                  entity_id: !input szene_nacht
              - service: input_select.select_option
                target:
                  entity_id: !input status_helper
                data:
                  option: "nacht"
              # KNX Status-R√ºckmeldung senden
              - if:
                  - condition: template
                    value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                then:
                  - service: knx.send
                    data:
                      address: "{{ status_rueckmeldung_ga }}"
                      payload: 1
      
      # Taster Automatik (Tag/Nacht abh√§ngig)
      - conditions:
          - condition: trigger
            id: auto
        sequence:
          - if:
              # Nacht-Modus (Sensor ist on)
              - condition: state
                entity_id: !input tag_nacht_sensor
                state: "on"
            then:
              - if:
                  # Nachtszene ist bereits aktiv
                  - condition: state
                    entity_id: !input status_helper
                    state: "nacht"
                then:
                  # Szenenbasiertes Ausschalten - nur Lichter der Nachtszene
                  - variables:
                      lights_to_turn_off: "{{ state_attr(szene_nacht, 'entity_id') or [] }}"
                  - if:
                      - condition: template
                        value_template: "{{ lights_to_turn_off | length > 0 }}"
                    then:
                      - service: homeassistant.turn_off
                        target:
                          entity_id: "{{ lights_to_turn_off }}"
                  - service: input_select.select_option
                    target:
                      entity_id: !input status_helper
                    data:
                      option: "aus"
                  # KNX Status-R√ºckmeldung senden
                  - if:
                      - condition: template
                        value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                    then:
                      - service: knx.send
                        data:
                          address: "{{ status_rueckmeldung_ga }}"
                          payload: 0
                else:
                  # Nachtszene aktivieren (beendet auch Durchgangsmodus)
                  - service: scene.turn_on
                    target:
                      entity_id: !input szene_nacht
                  - service: input_select.select_option
                    target:
                      entity_id: !input status_helper
                    data:
                      option: "nacht"
                  # KNX Status-R√ºckmeldung senden
                  - if:
                      - condition: template
                        value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                    then:
                      - service: knx.send
                        data:
                          address: "{{ status_rueckmeldung_ga }}"
                          payload: 1
            else:
              # Tag-Modus (Sensor ist off)
              - if:
                  # Tagszene ist bereits aktiv
                  - condition: state
                    entity_id: !input status_helper
                    state: "tag"
                then:
                  # Szenenbasiertes Ausschalten - nur Lichter der Tagszene
                  - variables:
                      lights_to_turn_off: "{{ state_attr(szene_tag, 'entity_id') or [] }}"
                  - if:
                      - condition: template
                        value_template: "{{ lights_to_turn_off | length > 0 }}"
                    then:
                      - service: homeassistant.turn_off
                        target:
                          entity_id: "{{ lights_to_turn_off }}"
                  - service: input_select.select_option
                    target:
                      entity_id: !input status_helper
                    data:
                      option: "aus"
                  # KNX Status-R√ºckmeldung senden
                  - if:
                      - condition: template
                        value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                    then:
                      - service: knx.send
                        data:
                          address: "{{ status_rueckmeldung_ga }}"
                          payload: 0
                else:
                  # Tagszene aktivieren (beendet auch Durchgangsmodus)
                  - service: scene.turn_on
                    target:
                      entity_id: !input szene_tag
                  - service: input_select.select_option
                    target:
                      entity_id: !input status_helper
                    data:
                      option: "tag"
                  # KNX Status-R√ºckmeldung senden
                  - if:
                      - condition: template
                        value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                    then:
                      - service: knx.send
                        data:
                          address: "{{ status_rueckmeldung_ga }}"
                          payload: 1
      
      # Taster Alles Aus
      - conditions:
          - condition: trigger
            id: alles_aus
          # Nur wenn eine echte GA konfiguriert ist (nicht der Default)
          - condition: template
            value_template: "{{ taster_aus_ga != '31/7/255' }}"
        sequence:
          # Schalte alle Entit√§ten aus, egal welcher Status
          - service: homeassistant.turn_off
            target:
              entity_id: !input licht_gruppe
          - service: input_select.select_option
            target:
              entity_id: !input status_helper
            data:
              option: "aus"
          # KNX Status-R√ºckmeldung senden
          - if:
              - condition: template
                value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
            then:
              - service: knx.send
                data:
                  address: "{{ status_rueckmeldung_ga }}"
                  payload: 0
      
      # Pr√§senzmelder EIN - Durchgangslicht aktivieren
      - conditions:
          - condition: trigger
            id: praesenz_on
          # Nur wenn Pr√§senzmelder NICHT der Tag/Nacht-Sensor ist (dann ist es deaktiviert)
          - condition: template
            value_template: "{{ praesenzmmelder != tag_nacht_sensor }}"
          # Und Durchgangsszene konfiguriert ist (nicht sun.sun)
          - condition: template
            value_template: "{{ szene_durchgang != 'sun.sun' }}"
        sequence:
          # Pr√ºfe ob Override-Schalter das Durchgangslicht blockiert
          - if:
              - condition: template
                value_template: >
                  {% if durchgang_override != 'sun.sun' %}
                    {% set domain = durchgang_override.split('.')[0] %}
                    {% if domain == 'media_player' %}
                      {{ states(durchgang_override) in ['on', 'playing', 'paused'] }}
                    {% else %}
                      {{ is_state(durchgang_override, 'on') }}
                    {% endif %}
                  {% else %}
                    false
                  {% endif %}
            then:
              # Override aktiv - nichts tun
              - stop: "Durchgangslicht Override ist aktiv"
          
          # Durchgangslicht aktivieren
          - if:
              # Wenn Licht aus ist ODER bereits im Durchgangsmodus
              - condition: or
                conditions:
                  - condition: state
                    entity_id: !input status_helper
                    state: "aus"
                  - condition: state
                    entity_id: !input status_helper
                    state: "durchgang"
            then:
              # W√§hle richtige Durchgangsszene basierend auf Tag/Nacht
              - if:
                  # Nacht-Modus (Sensor ist on) UND Nacht-Durchgangsszene konfiguriert
                  - condition: state
                    entity_id: !input tag_nacht_sensor
                    state: "on"
                  - condition: template
                    value_template: "{{ szene_durchgang_nacht != 'sun.sun' }}"
                then:
                  # Nacht-Durchgangsszene aktivieren
                  - service: scene.turn_on
                    data:
                      entity_id: !input szene_durchgang_nacht
                else:
                  # Tag-Durchgangsszene aktivieren (oder Standard wenn Nacht-Szene nicht konfiguriert)
                  - service: scene.turn_on
                    data:
                      entity_id: !input szene_durchgang
              - service: input_select.select_option
                target:
                  entity_id: !input status_helper
                data:
                  option: "durchgang"
              # KNX Status-R√ºckmeldung senden
              - if:
                  - condition: template
                    value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                then:
                  - service: knx.send
                    data:
                      address: "{{ status_rueckmeldung_ga }}"
                      payload: 1
      
      # Pr√§senzmelder AUS - Durchgangslicht ausschalten
      - conditions:
          - condition: trigger
            id: praesenz_off
          # Nur wenn im Durchgangsmodus
          - condition: state
            entity_id: !input status_helper
            state: "durchgang"
          # Zus√§tzliche Sicherheit: NICHT ausschalten wenn Tag/Nacht aktiv
          - condition: not
            conditions:
              - condition: state
                entity_id: !input status_helper
                state:
                  - "tag"
                  - "nacht"
        sequence:
          # Szenenbasiertes Ausschalten - ermittle welche Durchgangsszene aktiv war
          - variables:
              lights_to_turn_off: >
                {% if is_state(tag_nacht_sensor, 'on') and szene_durchgang_nacht != 'sun.sun' %}
                  {{ state_attr(szene_durchgang_nacht, 'entity_id') or [] }}
                {% else %}
                  {{ state_attr(szene_durchgang, 'entity_id') or [] }}
                {% endif %}
          - if:
              - condition: template
                value_template: "{{ lights_to_turn_off | length > 0 }}"
            then:
              - service: homeassistant.turn_off
                target:
                  entity_id: "{{ lights_to_turn_off }}"
          - service: input_select.select_option
            target:
              entity_id: !input status_helper
            data:
              option: "aus"
          # KNX Status-R√ºckmeldung senden
          - if:
              - condition: template
                value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
            then:
              - service: knx.send
                data:
                  address: "{{ status_rueckmeldung_ga }}"
                  payload: 0
      
      # Langzeit-Pr√§senzmelder 1 - Ausgew√§hlte Lichter ausschalten
      - conditions:
          - condition: trigger
            id: langzeit_1_off
          # Nur wenn Langzeit-Sensor NICHT der Tag/Nacht-Sensor ist (dann ist es deaktiviert)
          - condition: template
            value_template: "{{ praesenz_langzeit_1 != tag_nacht_sensor }}"
          # Nur wenn Langzeit-Sensor NICHT der Durchgangs-Sensor ist (sonst Konflikt)
          - condition: template
            value_template: "{{ praesenz_langzeit_1 != praesenzmmelder }}"
          # NUR wenn Status "aus" oder "durchgang" (NICHT bei aktiven Tag/Nacht-Szenen!)
          - condition: template
            value_template: "{{ states(status_helper) in ['aus', 'durchgang'] }}"
          # Nur wenn Lichter ausgew√§hlt wurden
          - condition: template
            value_template: "{{ praesenz_langzeit_1_lichter.entity_id is defined and praesenz_langzeit_1_lichter.entity_id | length > 0 }}"
        sequence:
          # Ausgew√§hlte Entit√§ten ausschalten
          - service: homeassistant.turn_off
            target: !input praesenz_langzeit_1_lichter
          # Optional: Status-R√ºckmeldung wenn alle Lichter aus sind
          - if:
              # Pr√ºfe ob Hauptlichtgruppe auch aus ist
              - condition: state
                entity_id: !input licht_gruppe
                state: "off"
            then:
              # Status Helper auf "aus" setzen
              - service: input_select.select_option
                target:
                  entity_id: !input status_helper
                data:
                  option: "aus"
              # KNX Status-R√ºckmeldung senden
              - if:
                  - condition: template
                    value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
                then:
                  - service: knx.send
                    data:
                      address: "{{ status_rueckmeldung_ga }}"
                      payload: 0
      
      # Langzeit-Pr√§senzmelder 2 - Szenenbasiertes Ausschalten (au√üer ausgeschlossene Labels)
      - conditions:
          - condition: trigger
            id: langzeit_2_off
          # Nur wenn Langzeit-Sensor NICHT der Tag/Nacht-Sensor ist (dann ist es deaktiviert)
          - condition: template
            value_template: "{{ praesenz_langzeit_2 != tag_nacht_sensor }}"
          # Nur wenn Langzeit-Sensor NICHT der Durchgangs-Sensor ist (sonst Konflikt)
          - condition: template
            value_template: "{{ praesenz_langzeit_2 != praesenzmmelder }}"
          # NUR wenn Status "aus" oder "durchgang" (NICHT bei aktiven Tag/Nacht-Szenen!)
          - condition: template
            value_template: "{{ states(status_helper) in ['aus', 'durchgang'] }}"
        sequence:
          # Ermittle welche Szene aktiv ist und hole deren Lichter
          - variables:
              scene_lights: >
                {% set current_status = states(status_helper) %}
                {% if current_status == 'tag' %}
                  {{ state_attr(szene_tag, 'entity_id') or [] }}
                {% elif current_status == 'nacht' %}
                  {{ state_attr(szene_nacht, 'entity_id') or [] }}
                {% elif current_status == 'durchgang' %}
                  {% if is_state(tag_nacht_sensor, 'on') and szene_durchgang_nacht != 'sun.sun' %}
                    {{ state_attr(szene_durchgang_nacht, 'entity_id') or [] }}
                  {% else %}
                    {{ state_attr(szene_durchgang, 'entity_id') or [] }}
                  {% endif %}
                {% else %}
                  []
                {% endif %}
              lights_to_turn_off: >
                {% set ns = namespace(lights=[]) %}
                {% set exclude_labels = praesenz_langzeit_2_exclude_labels %}
                {% set scene_lights_list = scene_lights %}
                {% for entity in scene_lights_list %}
                  {% set entity_labels = state_attr(entity, 'labels') or [] %}
                  {% set has_excluded_label = namespace(found=false) %}
                  {% for label in exclude_labels %}
                    {% if label in entity_labels %}
                      {% set has_excluded_label.found = true %}
                    {% endif %}
                  {% endfor %}
                  {% if not has_excluded_label.found %}
                    {% set ns.lights = ns.lights + [entity] %}
                  {% endif %}
                {% endfor %}
                {{ ns.lights }}
          
          # Schalte gefilterte Entit√§ten aus (wenn welche √ºbrig sind)
          - if:
              - condition: template
                value_template: "{{ lights_to_turn_off | length > 0 }}"
            then:
              - service: homeassistant.turn_off
                target:
                  entity_id: "{{ lights_to_turn_off }}"
          
          # Status Helper auf "aus" setzen
          - service: input_select.select_option
            target:
              entity_id: !input status_helper
            data:
              option: "aus"
          # KNX Status-R√ºckmeldung senden
          - if:
              - condition: template
                value_template: "{{ status_rueckmeldung_ga != '31/7/255' }}"
            then:
              - service: knx.send
                data:
                  address: "{{ status_rueckmeldung_ga }}"
                  payload: 0
